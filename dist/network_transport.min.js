!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("msgpack-lite"),require("pure-uuid")):"function"==typeof define&&define.amd?define("network_transport",["msgpack-lite","pure-uuid"],t):"object"==typeof exports?exports.network_transport=t(require("msgpack-lite"),require("pure-uuid")):e.network_transport=t(e.msgpack,e.UUID)}(this,function(__WEBPACK_EXTERNAL_MODULE_0__,__WEBPACK_EXTERNAL_MODULE_1__){return function(e){function t(o){if(r[o])return r[o].exports;var n=r[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var r={};return t.m=e,t.c=r,t.i=function(e){return e},t.d=function(e,r,o){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:o})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=2)}([function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE_0__},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE_1__},function(module,exports,__webpack_require__){"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.NetworkTransport=exports.APIError=exports.DependencyError=void 0;var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),_msgpack=__webpack_require__(0),_msgpack2=_interopRequireDefault(_msgpack),_UUID=__webpack_require__(1),_UUID2=_interopRequireDefault(_UUID),DependencyError=exports.DependencyError=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return _inherits(t,e),t}(Error),APIError=exports.APIError=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return _inherits(t,e),t}(Error);if("undefined"==typeof window){if("undefined"==typeof WebSocket)var _WebSocket=eval("require('websocket')").client;if("undefined"==typeof XMLHttpRequest)var _XMLHttpRequest=eval("require('xmlhttprequest')").XMLHttpRequest;if("undefined"==typeof console)var _console=eval("require('console')");var _document=void 0}else var _WebSocket2=window.WebSocket,_XMLHttpRequest2=window.XMLHttpRequest,_console2=window.console,_document2=window.document;if("undefined"!=typeof WebSocket){if(!_msgpack2.default)throw new DependencyError("This library requires msgpack-lite");if(!_UUID2.default)throw new DependencyError("This library requires pure-uuid")}if("undefined"==typeof XMLHttpRequest)throw new DependencyError("This library requires XMLHttpRequest");if("undefined"==typeof console)throw new DependencyError("This library requires console");var send_data_to_subscribers=function(e,t,r){if(t in e)for(var o=0;o<e[t].length;o++)e[t][o].next(r)},return_http_response=function(e,t){var r=void 0,o=e.target.status;try{r=JSON.parse(e.target.response)}catch(t){if(t instanceof SyntaxError)return void console.error("Cannot parse HTTP response JSON",e.target.response);throw t}t(o,r)},init_socket=function(e,t){t.socket=new WebSocket(e),t.socket.binaryType="arraybuffer",t.socket.onmessage=function(e){if(e&&e.data){var r=void 0;try{var o=_msgpack2.default.decode(new Uint8Array(e.data));if(console.log("WS receiving (raw)...",o),r=JSON.parse(o),console.log("WS receiving (parsed)...",r),!r||!r.stream||!r.payload)return void console.error("socket message does not match expected pattern. message:"+JSON.stringify(r))}catch(e){return void(e instanceof SyntaxError?console.error("Cannot parse WS response JSON"):console.error(e))}if(r.payload){var n=r.payload.data,s=r.payload.response_status;n&&s&&r.payload.request_id in t.router&&(t.router[r.payload.request_id].callback(s,n),delete t.router[r.payload.request_id])}send_data_to_subscribers(t.subject_map,"*",r),send_data_to_subscribers(t.subject_map,r.stream,r)}},t.socket.onopen=function(){t.in_progress=!1;for(var r=null;r=t.queue.shift();)socket_send(e,t,r)}},socket_send=function(e,t,r,o){var n=!1;if(o&&!r.payload.request_id&&(r.payload.request_id=new _UUID2.default(4).format(),t.router[r.payload.request_id]={time:(new Date).getTime(),callback:o}),null!==t.socket&&t.socket.readyState!==t.socket.CONNECTING&&t.socket.readyState!==t.socket.CLOSED||(n=!0),n)return t.queue.push(r),void(t.in_progress||(init_socket(e,t),t.in_progress=!0));console.log("WS sending...",r),t.socket.send(_msgpack2.default.encode(r))},http_transport_func=function(e,t,r,o,n,s,a,i,c,u,p,_){var l=new XMLHttpRequest,f="";n&&(f="/"+encodeURIComponent(n));var d="";s&&(d=encodeURIComponent(s)+"/");var h="";if(a&&a instanceof Object){h="?";for(var y in a)h+=encodeURIComponent(y)+"="+encodeURIComponent(a[y])+"&";h=h.slice(0,-1)}var b=e+r+o+f+"/"+d+h;console.log("Sending http request to url: ",b),l.open(t,b,!0),l.setRequestHeader("Content-Type","application/json");for(var k in c)l.setRequestHeader(k,c[k]);u&&(l.withCredentials=!0),p&&(l.onload=function(e){return_http_response(e,p)},l.onerror=function(e){return_http_response(e,p)},l.onabort=function(e){return_http_response(e,p)},l.ontimeout=function(e){return_http_response(e,p)}),l.send(JSON.stringify(i))},ws_transport_func=function(e,t,r,o,n,s,a,i,c,u,p,_){var l={method:t};s&&(l.action=s),n&&(l.pk=n),a&&(l.query_params=a),i&&(l.data=i),socket_send(e+r,_,{stream:o,payload:l},p)},transport_funcs={http:function(){http_transport_func.prototype.constructor.apply(this,["http://"].concat(Array.prototype.slice.call(arguments)))},https:function(){http_transport_func.prototype.constructor.apply(this,["https://"].concat(Array.prototype.slice.call(arguments)))},websocket_msgpack:function(){ws_transport_func.prototype.constructor.apply(this,["ws://"].concat(Array.prototype.slice.call(arguments)))},websocket_msgpack_secure:function(){ws_transport_func.prototype.constructor.apply(this,["wss://"].concat(Array.prototype.slice.call(arguments)))}},transport_types=["http","https","websocket_msgpack","websocket_msgpack_secure"],NetworkTransport=exports.NetworkTransport=function(){function e(t,r,o){if(_classCallCheck(this,e),this.socket_connection={socket:null,in_progress:!1,queue:[],router:{},subject_map:{}},this.api_url=t,this.garbage_collect_timeout=o||6e4,"string"!=typeof this.api_url)throw new APIError("api_url must be a string.");if(this.transports=r,!(this.transports instanceof Array))throw new APIError("transports must be an array.");0==this.transports.length&&(this.transports=["http"]);for(var n=0;n<this.transports.length;n++)if(transport_types.indexOf(this.transports[n])===-1)throw new APIError(this.transports[n]+" is not a supported transport.");var s=this.transports.indexOf("websocket_msgpack");s!==-1&&(WebSocket||(this.transports.splice(s,1),console.warn("not using websockets because they are not supported.")));var a=this.transports.indexOf("websocket_msgpack_secure");a!==-1&&(WebSocket||(this.transports.splice(a,1),console.warn("not using secure websockets because they are not supported."))),this.garbage_collect()}return _createClass(e,[{key:"send",value:function(e,t){if(!e)throw new APIError("request is not defined or blank.");if(!("endpoint"in e))throw new APIError("request must contain endpoint.");var r=e.force_transport;if(r||(r=this.transports[this.transports.length-1]),this.transports.indexOf(r)===-1)throw new APIError(r+" is not an active transport.");"websocket_msgpack"===r&&e.headers&&console.warn("websocket transport does not support headers."),transport_funcs[r](e.method||"GET",this.api_url,e.endpoint,e.id,e.custom_method,e.query_params,e.data,e.headers,e.with_credentials||!0,t,this.socket_connection)}},{key:"subscribe_endpoint",value:function(e,t){e in this.socket_connection.subject_map||(this.socket_connection.subject_map[e]=[]),this.socket_connection.subject_map[e].indexOf(t)===-1&&this.socket_connection.subject_map[e].push(t)}},{key:"garbage_collect",value:function(){var e=this;console.log("garbage collection started...");var t=(new Date).getTime();for(var r in this.socket_connection.router)t-this.socket_connection.router[r].time>this.garbage_collect_timeout&&(delete this.socket_connection.router[r],console.log("garbage collected request callback ",r));console.log("garbage collection ended."),setTimeout(function(){e.garbage_collect()},this.garbage_collect_timeout)}},{key:"read_cookie",value:function(e){if("undefined"==typeof document||void 0===document.cookie)throw new APIError("Current context has no cookies");for(var t=e+"=",r=document.cookie.split(";"),o=0;o<r.length;o++){for(var n=r[o];" "==n.charAt(0);)n=n.substring(1,n.length);if(0==n.indexOf(t))return n.substring(t.length,n.length)}return null}}]),e}(),Library=function(){function e(t,r){_classCallCheck(this,e),this._name="network_transport"}return _createClass(e,[{key:"name",get:function(){return this._name}}]),e}();exports.default=Library}])});